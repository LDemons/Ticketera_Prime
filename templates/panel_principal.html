{% extends 'base.html' %}
{% load ticket_tags %}

{% block title %}Ticketera · Panel Principal{% endblock %}

{% block content %}
    <header class="header">
        <h1 class="page-title">Panel principal</h1>
        <div class="filters">
            <a href="{% url 'dashboard' %}" class="btn-link">Ver Gráficos</a>
            <a href="{% url 'reportes' %}" class="btn-link">Ver Reportes</a>
        </div>
    </header>

    <main style="padding: 16px;">
        <!-- KPIs -->
        <section class="kpis" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
            <article class="kpi">
                <div class="kpi-title">Abiertos</div>
                <div class="kpi-value">{{ tickets_abiertos }}</div>
                <div class="kpi-foot">
                    <span class="dot dot--blue"></span> 
                    Variación 24h: <b>+{{ abiertos_variacion }}</b>
                </div>
            </article>

            <article class="kpi">
                <div class="kpi-title">En curso</div>
                <div class="kpi-value">{{ tickets_en_progreso }}</div>
                <div class="kpi-foot">
                    <span class="dot dot--green"></span> 
                    Asignados 24h: <b>+{{ en_progreso_variacion }}</b>
                </div>
            </article>

            <article class="kpi">
                <div class="kpi-title">SLA vencidos</div>
                <div class="kpi-value alert">{{ sla_vencidos }}</div>
                <div class="kpi-foot">
                    <span class="dot dot--red"></span> 
                    Últimas 24h: <b>+{{ sla_vencidos_variacion }}</b>
                </div>
            </article>

            <article class="kpi">
                <div class="kpi-title">Tiempo resp. prom.</div>
                <div class="kpi-value">{{ tiempo_respuesta }}</div>
                <div class="kpi-foot">
                    <span class="dot"></span> 
                    Meta: <b>20m</b>
                </div>
            </article>
        </section>

        <!-- Gráfico de Entradas por Hora + Cumplimiento SLA -->
        <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 16px; margin-bottom: 20px;">
            <!-- Entradas por hora -->
            <section class="card">
                <div class="card-head">
                    <h2>Entradas por hora</h2>
                    <div class="filters">
                        <a href="{% url 'dashboard' %}" class="btn-link" style="font-size: 13px; padding: 6px 10px;">Ver Gráficos Detallados</a>
                    </div>
                </div>
                <div style="padding: 15px;">
                    <canvas id="chartEntradasPorHora" style="max-height: 220px;"></canvas>
                </div>
            </section>

            <!-- Cumplimiento SLA -->
            <section class="card">
                <div class="card-head">
                    <h2>Cumplimiento SLA</h2>
                </div>
                <div class="progress" style="padding: 15px;">
                    {% for item in cumplimiento_sla %}
                    <div class="progress-row">
                        <span style="font-size: 13px; color: var(--muted);">{{ item.nivel }}</span>
                        <div class="bar">
                            <i style="--p: {{ item.porcentaje }}%; 
                                {% if item.porcentaje >= 90 %}background: linear-gradient(90deg, var(--green), #9be1c2);
                                {% elif item.porcentaje >= 70 %}background: linear-gradient(90deg, #fbbf24, #fde68a);
                                {% else %}background: linear-gradient(90deg, var(--red), #fca5a5);{% endif %}">
                            </i>
                        </div>
                        <span style="font-weight: 700; font-size: 14px;">{{ item.porcentaje }}%</span>
                    </div>
                    {% endfor %}
                </div>
            </section>
        </div>

        <!-- Mi Cola con toggle Lista/Kanban -->
        <section class="card">
            <div class="card-head">
                <h2>Mi cola</h2>
                <div class="filters">
                    <div class="select">
                        <select id="vistaToggle" onchange="toggleVista(this.value)">
                            <option value="lista">Lista</option>
                            <option value="kanban">Kanban</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Vista Lista (por defecto) -->
            <div id="vistaLista" class="table" style="padding: 6px 10px 12px;">
                <div class="thead">
                    <div>ID</div>
                    <div>Asunto</div>
                    <div>Solicitante</div>
                    <div>Prioridad</div>
                    <div>Estado</div>
                    <div>Vence</div>
                </div>
                {% for ticket in tickets_recientes %}
                <div class="trow {% if ticket.prioridad and ticket.prioridad.Tipo_Nivel == 'ALTO' %}warn{% endif %}">
                    <div class="muted">#T{{ ticket.ticket_id|stringformat:"03d" }}</div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="avatar" style="background: {{ ticket.usuario_creador.nombre|user_color }}; width: 24px; height: 24px; font-size: 11px;">
                            {{ ticket.usuario_creador.nombre|first }}
                        </div>
                        <a href="{% url 'ticket_detail' ticket.ticket_id %}" style="color: var(--text); text-decoration: none;">
                            {{ ticket.titulo|truncatewords:8 }}
                        </a>
                    </div>
                    <div class="muted">{{ ticket.usuario_creador.nombre }}</div>
                    <div>
                        {% if ticket.prioridad %}
                            {% if ticket.prioridad.Tipo_Nivel == 'ALTO' %}
                                <b class="tag tag--high">{{ ticket.prioridad.Tipo_Nivel }}</b>
                            {% elif ticket.prioridad.Tipo_Nivel == 'MEDIO' %}
                                <b class="tag tag--medium">{{ ticket.prioridad.Tipo_Nivel }}</b>
                            {% else %}
                                <b class="tag tag--low">{{ ticket.prioridad.Tipo_Nivel }}</b>
                            {% endif %}
                        {% else %}
                            <span class="muted">-</span>
                        {% endif %}
                    </div>
                    <div>
                        {% if ticket.estado == 'ABIERTO' %}
                            <b class="tag tag--open">{{ ticket.get_estado_display }}</b>
                        {% elif ticket.estado == 'EN_PROGRESO' %}
                            <b class="tag tag--progress">{{ ticket.get_estado_display }}</b>
                        {% elif ticket.estado == 'RESUELTO' %}
                            <b class="tag tag--resolved">{{ ticket.get_estado_display }}</b>
                        {% elif ticket.estado == 'CERRADO' %}
                            <b class="tag tag--closed">{{ ticket.get_estado_display }}</b>
                        {% else %}
                            <b class="tag">{{ ticket.get_estado_display }}</b>
                        {% endif %}
                    </div>
                    <div class="muted">{{ ticket.fecha_creacion|date:"d/m/Y" }}</div>
                </div>
                {% empty %}
                <div class="bulk-bar" style="margin: 10px 0;">
                    No hay tickets pendientes de asignación.
                </div>
                {% endfor %}
            </div>

            <!-- Vista Kanban (oculta por defecto) -->
            <div id="vistaKanban" style="display: none; padding: 15px;">
                <div class="kanban-board">
                    <!-- Columna ABIERTO -->
                    <div class="kanban-column">
                        <div class="kanban-header" style="background: var(--blue-100); color: var(--blue);">
                            <h3>Abierto</h3>
                            <span class="badge">{{ tickets_kanban.ABIERTO|length }}</span>
                        </div>
                        <div class="kanban-cards">
                            {% for ticket in tickets_kanban.ABIERTO %}
                            <div class="kanban-card">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <div class="avatar" style="background: {{ ticket.usuario_creador.nombre|user_color }}; width: 28px; height: 28px; font-size: 12px;">
                                        {{ ticket.usuario_creador.nombre|first }}
                                    </div>
                                    <span class="muted small">#T{{ ticket.ticket_id|stringformat:"03d" }}</span>
                                </div>
                                <a href="{% url 'ticket_detail' ticket.ticket_id %}" style="color: var(--text); text-decoration: none; font-weight: 600; display: block; margin-bottom: 8px;">
                                    {{ ticket.titulo|truncatewords:6 }}
                                </a>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                                    {% if ticket.prioridad.Tipo_Nivel == 'ALTO' %}
                                        <b class="tag tag--high" style="font-size: 11px;">ALTO</b>
                                    {% elif ticket.prioridad.Tipo_Nivel == 'MEDIO' %}
                                        <b class="tag tag--medium" style="font-size: 11px;">MEDIO</b>
                                    {% else %}
                                        <b class="tag tag--low" style="font-size: 11px;">BAJO</b>
                                    {% endif %}
                                    <span class="muted small">{{ ticket.fecha_creacion|date:"d/m" }}</span>
                                </div>
                            </div>
                            {% empty %}
                            <div class="kanban-empty">Sin tickets</div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Columna EN PROGRESO -->
                    <div class="kanban-column">
                        <div class="kanban-header" style="background: #fff7e7; color: #8a5a12;">
                            <h3>En Progreso</h3>
                            <span class="badge">{{ tickets_kanban.EN_PROGRESO|length }}</span>
                        </div>
                        <div class="kanban-cards">
                            {% for ticket in tickets_kanban.EN_PROGRESO %}
                            <div class="kanban-card">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <div class="avatar" style="background: {{ ticket.usuario_creador.nombre|user_color }}; width: 28px; height: 28px; font-size: 12px;">
                                        {{ ticket.usuario_creador.nombre|first }}
                                    </div>
                                    <span class="muted small">#T{{ ticket.ticket_id|stringformat:"03d" }}</span>
                                </div>
                                <a href="{% url 'ticket_detail' ticket.ticket_id %}" style="color: var(--text); text-decoration: none; font-weight: 600; display: block; margin-bottom: 8px;">
                                    {{ ticket.titulo|truncatewords:6 }}
                                </a>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                                    {% if ticket.prioridad %}
                                        {% if ticket.prioridad.Tipo_Nivel == 'ALTO' %}
                                            <b class="tag tag--high" style="font-size: 11px;">ALTO</b>
                                        {% elif ticket.prioridad.Tipo_Nivel == 'MEDIO' %}
                                            <b class="tag tag--medium" style="font-size: 11px;">MEDIO</b>
                                        {% else %}
                                            <b class="tag tag--low" style="font-size: 11px;">BAJO</b>
                                        {% endif %}
                                    {% else %}
                                        <span class="muted small">-</span>
                                    {% endif %}
                                    <span class="muted small">{{ ticket.fecha_creacion|date:"d/m" }}</span>
                                </div>
                            </div>
                            {% empty %}
                            <div class="kanban-empty">Sin tickets</div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Columna RESUELTO -->
                    <div class="kanban-column">
                        <div class="kanban-header" style="background: #e8f5e9; color: var(--green);">
                            <h3>Resuelto</h3>
                            <span class="badge">{{ tickets_kanban.RESUELTO|length }}</span>
                        </div>
                        <div class="kanban-cards">
                            {% for ticket in tickets_kanban.RESUELTO %}
                            <div class="kanban-card">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <div class="avatar" style="background: {{ ticket.usuario_creador.nombre|user_color }}; width: 28px; height: 28px; font-size: 12px;">
                                        {{ ticket.usuario_creador.nombre|first }}
                                    </div>
                                    <span class="muted small">#T{{ ticket.ticket_id|stringformat:"03d" }}</span>
                                </div>
                                <a href="{% url 'ticket_detail' ticket.ticket_id %}" style="color: var(--text); text-decoration: none; font-weight: 600; display: block; margin-bottom: 8px;">
                                    {{ ticket.titulo|truncatewords:6 }}
                                </a>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                                    {% if ticket.prioridad %}
                                        {% if ticket.prioridad.Tipo_Nivel == 'ALTO' %}
                                            <b class="tag tag--high" style="font-size: 11px;">ALTO</b>
                                        {% elif ticket.prioridad.Tipo_Nivel == 'MEDIO' %}
                                            <b class="tag tag--medium" style="font-size: 11px;">MEDIO</b>
                                        {% else %}
                                            <b class="tag tag--low" style="font-size: 11px;">BAJO</b>
                                        {% endif %}
                                    {% else %}
                                        <span class="muted small">-</span>
                                    {% endif %}
                                    <span class="muted small">{{ ticket.fecha_creacion|date:"d/m" }}</span>
                                </div>
                            </div>
                            {% empty %}
                            <div class="kanban-empty">Sin tickets</div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Columna CERRADO -->
                    <div class="kanban-column">
                        <div class="kanban-header" style="background: #f5f5f5; color: var(--muted);">
                            <h3>Cerrado</h3>
                            <span class="badge">{{ tickets_kanban.CERRADO|length }}</span>
                        </div>
                        <div class="kanban-cards">
                            {% for ticket in tickets_kanban.CERRADO %}
                            <div class="kanban-card">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <div class="avatar" style="background: {{ ticket.usuario_creador.nombre|user_color }}; width: 28px; height: 28px; font-size: 12px;">
                                        {{ ticket.usuario_creador.nombre|first }}
                                    </div>
                                    <span class="muted small">#T{{ ticket.ticket_id|stringformat:"03d" }}</span>
                                </div>
                                <a href="{% url 'ticket_detail' ticket.ticket_id %}" style="color: var(--text); text-decoration: none; font-weight: 600; display: block; margin-bottom: 8px;">
                                    {{ ticket.titulo|truncatewords:6 }}
                                </a>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                                    {% if ticket.prioridad %}
                                        {% if ticket.prioridad.Tipo_Nivel == 'ALTO' %}
                                            <b class="tag tag--high" style="font-size: 11px;">ALTO</b>
                                        {% elif ticket.prioridad.Tipo_Nivel == 'MEDIO' %}
                                            <b class="tag tag--medium" style="font-size: 11px;">MEDIO</b>
                                        {% else %}
                                            <b class="tag tag--low" style="font-size: 11px;">BAJO</b>
                                        {% endif %}
                                    {% else %}
                                        <span class="muted small">-</span>
                                    {% endif %}
                                    <span class="muted small">{{ ticket.fecha_creacion|date:"d/m" }}</span>
                                </div>
                            </div>
                            {% empty %}
                            <div class="kanban-empty">Sin tickets</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Toggle entre vista Lista y Kanban
        function toggleVista(vista) {
            const vistaLista = document.getElementById('vistaLista');
            const vistaKanban = document.getElementById('vistaKanban');
            
            if (vista === 'kanban') {
                vistaLista.style.display = 'none';
                vistaKanban.style.display = 'block';
            } else {
                vistaLista.style.display = 'block';
                vistaKanban.style.display = 'none';
            }
        }

        // Gráfico de Entradas por Hora
        const ctxHoras = document.getElementById('chartEntradasPorHora');
        if (ctxHoras) {
            const labelsHoras = {{ labels_horas_json|safe }};
            const dataHoras = {{ tickets_por_hora_json|safe }};

            new Chart(ctxHoras, {
                type: 'bar',
                data: {
                    labels: labelsHoras,
                    datasets: [{
                        label: 'Tickets creados',
                        data: dataHoras,
                        backgroundColor: 'rgba(47, 115, 217, 0.8)',
                        borderColor: 'rgba(47, 115, 217, 1)',
                        borderWidth: 1,
                        borderRadius: 6,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 10,
                            cornerRadius: 8,
                            titleFont: { size: 13 },
                            bodyFont: { size: 12 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                font: { size: 11 }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                font: { size: 11 },
                                maxRotation: 45,
                                minRotation: 0
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
    </script>
{% endblock %}