{% extends 'base.html' %}

{% block title %}Gestionando Ticket #{{ ticket.ticket_id }}{% endblock %}

{% block content %}
    <header class="header">
        <div>
            <h1 class="page-title">Gestionando Ticket #{{ ticket.ticket_id }}</h1>
            <p class="small muted">
                <b>{{ ticket.titulo }}</b>
            </p>
        </div>
        <div class="filters">
            <a href="{% url 'mis_asignaciones' %}" class="btn-link">← Volver a Mis Asignaciones</a>
        </div>
    </header>

    <div style="display: grid; grid-template-columns: 2fr 1fr; height: calc(100vh - 64px);">
        
        <main class="list" style="padding: 20px; overflow-y: auto;">
            
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-head">
                    <h2>Detalles del Solicitante</h2>
                </div>
                <div style="padding: 15px;">
                    <p>
                        <b>Solicitante:</b> {{ ticket.usuario_creador.nombre }} <br>
                        <b>Email:</b> {{ ticket.usuario_creador.email }}
                    </p>
                    <hr style="border:0; border-top: 1px solid var(--line);">
                    <p><b>Descripción Original:</b></p>
                    <p>{{ ticket.descripcion }}</p>
                </div>
            </div>

            <h2>Historial de Actividad</h2>
            {% for comentario in comentarios %}
            <div class="bubble" style="background: {% if comentario.autor.rol.nombre == 'TI' %}#e5f0ff{% else %}var(--card){% endif %}; border: 1px solid var(--line); margin-bottom: 15px;">
                <p>
                    <strong>{{ comentario.autor.nombre }}</strong> 
                    <span class="muted small">({{ comentario.autor.rol.nombre }})</span>
                    <span class="muted small" style="float: right;">{{ comentario.fecha_creacion }}</span>
                </p>
                <p>{{ comentario.contenido }}</p>
            </div>
            {% empty %}
            <div class="bulk-bar">
                No hay comentarios en este ticket todavía.
            </div>
            {% endfor %}

        </main>

        <aside class="detail" style="padding: 20px;">
            <h3>Acciones</h3>
            <form method="post">
                {% csrf_token %}
                
                <p>
                    <label for="{{ form.estado.id_for_label }}">Actualizar Estado:</label>
                    {{ form.estado }}
                </p>
                <p>
                    <label for="{{ form.contenido.id_for_label }}">{{ form.contenido.label }}:</label>
                    {{ form.contenido }}
                </p>

                <button type="submit" class="btn-link" style="background: var(--indigo-800); color: #fff; width: 100%; margin-top: 10px;">
                    Actualizar Ticket
                </button>
            </form>
        </aside>

    </div>
{% endblock %}