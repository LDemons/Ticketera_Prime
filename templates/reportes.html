{% extends 'base.html' %}

{% block title %}Ticketera · Reportes{% endblock %}

{% block content %}
    <header class="header">
      <h1 class="page-title">Reportes Simples</h1>

            <form method="GET" action="{% url 'reportes' %}" class="filters">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <label for="fecha_desde" style="font-size: 14px; color: var(--muted);">Desde:</label>
                    <input type="date" id="fecha_desde" name="fecha_desde" 
                        value="{{ fecha_desde_str|default:'' }}" 
                        style="padding: 6px 8px; border: 1px solid var(--line); border-radius: 6px;">
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <label for="fecha_hasta" style="font-size: 14px; color: var(--muted);">Hasta:</label>
                    <input type="date" id="fecha_hasta" name="fecha_hasta" 
                        value="{{ fecha_hasta_str|default:'' }}" 
                        style="padding: 6px 8px; border: 1px solid var(--line); border-radius: 6px;">
                </div>
                <button type="submit" class="btn-link" style="padding: 7px 15px;">Filtrar</button>

                {% if fecha_desde_str or fecha_hasta_str %}
                <a href="{% url 'reportes' %}" class="btn-link" 
                style="padding: 7px 15px; border-color: var(--indigo-800); color: var(--indigo-800);">
                Limpiar Filtros
                </a>
                {% endif %}

                <a href="{% url 'descargar_reporte_csv' %}?fecha_desde={{ fecha_desde_str }}&fecha_hasta={{ fecha_hasta_str }}" 
                   class="btn-link" 
                   style="padding: 7px 15px; background: var(--green); color: #fff; border-color: var(--green);">
                    <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: none; stroke: currentColor; stroke-width: 2; vertical-align: middle; margin-right: 5px;">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Descargar CSV
                </a>
            </form>
      </header>

     <main style="padding: 16px;">

        <!-- Comparación Mensual -->
        <section class="card" style="margin-bottom: 20px;">
            <div class="card-head">
                <h2>Comparación Mensual</h2>
            </div>
            <div style="padding: 20px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; align-items: center;">
                <!-- Mes Anterior -->
                <div style="text-align: center;">
                    <div style="font-size: 14px; color: var(--muted); margin-bottom: 5px;">{{ comparacion_mensual.mes_anterior }}</div>
                    <div style="font-size: 32px; font-weight: 700; color: var(--text);">{{ comparacion_mensual.tickets_mes_anterior }}</div>
                    <div style="font-size: 13px; color: var(--muted);">tickets creados</div>
                </div>

                <!-- Indicador de Cambio -->
                <div style="text-align: center;">
                    {% if comparacion_mensual.aumento %}
                        <svg viewBox="0 0 24 24" style="width: 48px; height: 48px; stroke: var(--red); fill: none; stroke-width: 2; margin-bottom: 10px;">
                            <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                            <polyline points="17 6 23 6 23 12"></polyline>
                        </svg>
                        <div style="font-size: 28px; font-weight: 800; color: var(--red);">
                            +{{ comparacion_mensual.porcentaje_cambio }}%
                        </div>
                        <div style="font-size: 13px; color: var(--muted);">incremento</div>
                    {% else %}
                        <svg viewBox="0 0 24 24" style="width: 48px; height: 48px; stroke: var(--green); fill: none; stroke-width: 2; margin-bottom: 10px;">
                            <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline>
                            <polyline points="17 18 23 18 23 12"></polyline>
                        </svg>
                        <div style="font-size: 28px; font-weight: 800; color: var(--green);">
                            {{ comparacion_mensual.porcentaje_cambio }}%
                        </div>
                        <div style="font-size: 13px; color: var(--muted);">reducción</div>
                    {% endif %}
                </div>

                <!-- Mes Actual -->
                <div style="text-align: center;">
                    <div style="font-size: 14px; color: var(--muted); margin-bottom: 5px;">{{ comparacion_mensual.mes_actual }}</div>
                    <div style="font-size: 32px; font-weight: 700; color: var(--text);">{{ comparacion_mensual.tickets_mes_actual }}</div>
                    <div style="font-size: 13px; color: var(--muted);">tickets creados</div>
                </div>
            </div>
        </section>

        <div class="cards"> <section class="card">
                <div class="card-head">
                    <h2>Tickets por Estado</h2>
                </div>
                <div class="table" style="padding: 15px;"> {% if reporte_estados %}
                    <table>
                        <thead>
                            <tr>
                                <th style="text-align: left; padding-bottom: 8px;">Estado</th>
                                <th style="text-align: right; padding-bottom: 8px;">Cantidad</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in reporte_estados %}
                            <tr>
                                <td style="padding: 5px 0;">{{ item.estado }}</td>
                                <td style="text-align: right; padding: 5px 0;">{{ item.total }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="muted">No hay tickets para mostrar.</p>
                    {% endif %}
                </div>
            </section>

            <section class="card">
                <div class="card-head">
                    <h2>Tickets por Categoría</h2>
                </div>
                 <div class="table" style="padding: 15px;">
                    {% if reporte_categorias %}
                    <table>
                        <thead>
                            <tr>
                                <th style="text-align: left; padding-bottom: 8px;">Categoría</th>
                                <th style="text-align: right; padding-bottom: 8px;">Cantidad</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in reporte_categorias %}
                            <tr>
                                <td style="padding: 5px 0;">{{ item.categoria }}</td>
                                <td style="text-align: right; padding: 5px 0;">{{ item.total }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="muted">No hay tickets registrados con categorías.</p> {# Mensaje ajustado #}
                    {% endif %}
                </div>
            </section>
            
            <section class="card">
                <div class="card-head">
                    <h2>Tickets por Prioridad</h2>
                </div>
                 <div class="table" style="padding: 15px;">
                    {% if reporte_prioridades %}
                    <table>
                        <thead>
                            <tr>
                                <th style="text-align: left; padding-bottom: 8px;">Prioridad</th>
                                <th style="text-align: right; padding-bottom: 8px;">Cantidad</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in reporte_prioridades %}
                            <tr>
                                <td style="padding: 5px 0;">
                                    {# Opcional: Añadir tag de color #}
                                    {% if item.prioridad == 'Alto' %} <b class="tag tag--high">ALTO</b>
                                    {% elif item.prioridad == 'Medio' %} <b class="tag tag--medium">MEDIO</b>
                                    {% elif item.prioridad == 'Bajo' %} <b class="tag tag--low">BAJO</b>
                                    {% else %} {{ item.prioridad }} {% endif %}
                                </td>
                                <td style="text-align: right; padding: 5px 0;">{{ item.total }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="muted">No hay tickets registrados con prioridades.</p>
                    {% endif %}
                </div>
            </section>
            </div> </main>
{% endblock %}